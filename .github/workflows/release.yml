name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: true
        type: boolean
      build_targets:
        description: 'Build targets (comma-separated: cpu-linux,cpu-macos,cpu-windows,metal,cu118,cu124,cu128,cu124-windows or "all")'
        required: false
        default: 'all'
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # CPU Builds
  # ==========================================================================
  
  build-cpu-linux:
    name: Build CPU (Linux x86_64)
    runs-on: ubuntu-latest
    if: ${{ inputs.build_targets == 'all' || contains(inputs.build_targets, 'cpu-linux') }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels (manylinux)
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          manylinux: auto
          args: --release --features "onnx,symphonia" -o dist
          before-script-linux: |
            # Install protoc from GitHub releases (same version as arduino/setup-protoc)
            PB_REL="https://github.com/protocolbuffers/protobuf/releases"
            curl -LO $PB_REL/download/v28.3/protoc-28.3-linux-x86_64.zip
            unzip protoc-28.3-linux-x86_64.zip -d /usr/local
            rm protoc-28.3-linux-x86_64.zip
            protoc --version
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cpu-linux-x86_64
          path: dist/*.whl

  build-cpu-macos-arm64:
    name: Build CPU (macOS ARM64)
    runs-on: macos-14
    if: ${{ inputs.build_targets == 'all' || contains(inputs.build_targets, 'cpu-macos') }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64-apple-darwin
          args: --release --features "onnx,symphonia" -o dist
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cpu-macos-arm64
          path: dist/*.whl

  build-cpu-windows:
    name: Build CPU (Windows x86_64)
    runs-on: windows-latest
    if: ${{ inputs.build_targets == 'all' || contains(inputs.build_targets, 'cpu-windows') }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64-pc-windows-msvc
          args: --release --features "onnx,symphonia" -o dist
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cpu-windows-x86_64
          path: dist/*.whl

  # ==========================================================================
  # Metal Build (macOS ARM64)
  # ==========================================================================
  
  build-metal:
    name: Build Metal (macOS ARM64)
    runs-on: macos-14
    if: ${{ inputs.build_targets == 'all' || contains(inputs.build_targets, 'metal') }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set version with local identifier
        run: |
          # Update pyproject.toml version to include +metal local identifier
          sed -i '' 's/version = "[^"]*"/version = "${{ inputs.version }}+metal"/' pyproject.toml
          cat pyproject.toml | grep version
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64-apple-darwin
          args: --release --features "onnx,symphonia,metal" -o dist
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-metal-macos-arm64
          path: dist/*.whl

  # ==========================================================================
  # CUDA Builds (Linux)
  # ==========================================================================
  
  build-cuda-linux:
    name: Build CUDA ${{ matrix.cuda }} (Linux x86_64)
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - cuda: '11.8.0'
            cuda_short: 'cu118'
            gcc_version: '11'
          - cuda: '12.4.0'
            cuda_short: 'cu124'
            gcc_version: '12'
          - cuda: '12.8.0'
            cuda_short: 'cu128'
            gcc_version: '12'
    
    steps:
      - name: Check if should build
        id: check
        run: |
          if [[ "${{ inputs.build_targets }}" == "all" ]] || [[ "${{ inputs.build_targets }}" == *"${{ matrix.cuda_short }}"* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      
      - uses: actions/checkout@v4
        if: steps.check.outputs.should_build == 'true'
      
      - name: Install GCC ${{ matrix.gcc_version }}
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-${{ matrix.gcc_version }} g++-${{ matrix.gcc_version }}
      
      - name: Install CUDA Toolkit
        if: steps.check.outputs.should_build == 'true'
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: ${{ matrix.cuda }}
          method: 'network'
          sub-packages: '["nvcc", "cudart-dev", "nvrtc", "nvrtc-dev", "compat"]'
          non-cuda-sub-packages: '["libcublas", "libcublas-dev", "libcurand", "libcurand-dev"]'
      
      - name: Install protoc
        if: steps.check.outputs.should_build == 'true'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        if: steps.check.outputs.should_build == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install maturin
        if: steps.check.outputs.should_build == 'true'
        run: pip install maturin
      
      - name: Install Rust
        if: steps.check.outputs.should_build == 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set version with local identifier
        if: steps.check.outputs.should_build == 'true'
        run: |
          # Update pyproject.toml version to include +cuXXX local identifier
          sed -i 's/version = "[^"]*"/version = "${{ inputs.version }}+${{ matrix.cuda_short }}"/' pyproject.toml
          cat pyproject.toml | grep version
      
      - name: Build wheels
        if: steps.check.outputs.should_build == 'true'
        env:
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
          CUDA_COMPUTE_CAP: "80"
          NVCC_CCBIN: /usr/bin/gcc-${{ matrix.gcc_version }}
          CC: gcc-${{ matrix.gcc_version }}
          CXX: g++-${{ matrix.gcc_version }}
          LD_LIBRARY_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/compat:${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/lib64
        run: |
          mkdir -p dist
          maturin build --release --features "onnx,symphonia,cuda" -o dist
      
      - name: Upload artifact
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cuda-${{ matrix.cuda_short }}-linux-x86_64
          path: dist/*.whl

  # ==========================================================================
  # CUDA Builds (Windows) - Only CUDA 12.4 (CUDA 11.8 has thrust include issues)
  # ==========================================================================
  
  build-cuda-windows:
    name: Build CUDA 12.4 (Windows x86_64)
    runs-on: windows-2025
    if: ${{ inputs.build_targets == 'all' || contains(inputs.build_targets, 'cu124-windows') }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: '12.4.0'
          method: 'network'
          sub-packages: '["nvcc", "cudart", "cublas_dev", "curand_dev", "nvrtc_dev"]'
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install maturin
        run: pip install maturin
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Set version with local identifier
        shell: bash
        run: |
          # Update pyproject.toml version to include +cu124 local identifier
          sed -i 's/version = "[^"]*"/version = "${{ inputs.version }}+cu124"/' pyproject.toml
          cat pyproject.toml | grep version
      
      - name: Build wheels
        env:
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
          CUDA_COMPUTE_CAP: "80"
        run: |
          New-Item -ItemType Directory -Force -Path dist
          maturin build --release --features "onnx,symphonia,cuda" -o dist
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cuda-cu124-windows-x86_64
          path: dist/*.whl

  # ==========================================================================
  # Collect All Wheels (always runs, for download without release)
  # ==========================================================================
  
  collect-wheels:
    name: Collect All Wheels
    needs:
      - build-cpu-linux
      - build-cpu-macos-arm64
      - build-cpu-windows
      - build-metal
      - build-cuda-linux
      - build-cuda-windows
    if: ${{ always() }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-wheels
          merge-multiple: true
      
      - name: List all wheels
        run: |
          echo "=== All wheels built ==="
          ls -la all-wheels/
          echo ""
          echo "Total size:"
          du -sh all-wheels/
      
      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels-v${{ inputs.version }}
          path: all-wheels/*.whl
          retention-days: 30

  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  
  release:
    name: Create Release
    needs:
      - collect-wheels
    runs-on: ubuntu-latest
    if: ${{ inputs.create_release }}
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download combined wheels
        uses: actions/download-artifact@v4
        with:
          name: all-wheels-v${{ inputs.version }}
          path: dist
      
      - name: List wheels
        run: ls -la dist/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: cosyvoice3 v${{ inputs.version }}
          draft: true
          prerelease: false
          files: dist/*.whl
          body: |
            ## cosyvoice3 v${{ inputs.version }}
            
            ### Installation
            
            **CPU version (all platforms):**
            ```bash
            pip install cosyvoice3-${{ inputs.version }}-cp310-abi3-<platform>.whl
            ```
            
            **Metal version (macOS ARM64):**
            ```bash
            pip install cosyvoice3-${{ inputs.version }}+metal-cp310-abi3-macosx_11_0_arm64.whl
            ```
            
            **CUDA version (Linux/Windows):**
            ```bash
            # CUDA 11.8+ (maximum compatibility)
            pip install cosyvoice3-${{ inputs.version }}+cu118-cp310-abi3-<platform>.whl
            
            # CUDA 12.4+
            pip install cosyvoice3-${{ inputs.version }}+cu124-cp310-abi3-<platform>.whl
            
            # CUDA 12.8+ (latest features)
            pip install cosyvoice3-${{ inputs.version }}+cu128-cp310-abi3-<platform>.whl
            ```
            
            ### Wheels included
            
            | Variant | Platform | File |
            |---------|----------|------|
            | CPU | Linux x86_64 | `cosyvoice3-${{ inputs.version }}-*-manylinux*.whl` |
            | CPU | macOS ARM64 | `cosyvoice3-${{ inputs.version }}-*-macosx*arm64.whl` |
            | CPU | Windows x86_64 | `cosyvoice3-${{ inputs.version }}-*-win_amd64.whl` |
            | Metal | macOS ARM64 | `cosyvoice3-${{ inputs.version }}+metal-*-macosx*arm64.whl` |
            | CUDA 11.8 | Linux x86_64 | `cosyvoice3-${{ inputs.version }}+cu118-*-linux*.whl` |
            | CUDA 12.4 | Linux x86_64 | `cosyvoice3-${{ inputs.version }}+cu124-*-linux*.whl` |
            | CUDA 12.8 | Linux x86_64 | `cosyvoice3-${{ inputs.version }}+cu128-*-linux*.whl` |
            | CUDA 12.4 | Windows x86_64 | `cosyvoice3-${{ inputs.version }}+cu124-*-win_amd64.whl` |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
