name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # CPU Builds
  # ==========================================================================
  
  build-cpu-linux:
    name: Build CPU (Linux x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels (manylinux)
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          manylinux: auto
          args: --release --features "onnx,symphonia" -o dist
          before-script-linux: |
            # Install protoc from GitHub releases (same version as arduino/setup-protoc)
            PB_REL="https://github.com/protocolbuffers/protobuf/releases"
            curl -LO $PB_REL/download/v28.3/protoc-28.3-linux-x86_64.zip
            unzip protoc-28.3-linux-x86_64.zip -d /usr/local
            rm protoc-28.3-linux-x86_64.zip
            protoc --version
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cpu-linux-x86_64
          path: dist/*.whl

  build-cpu-macos-arm64:
    name: Build CPU (macOS ARM64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64-apple-darwin
          args: --release --features "onnx,symphonia" -o dist
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cpu-macos-arm64
          path: dist/*.whl

  build-cpu-windows:
    name: Build CPU (Windows x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64-pc-windows-msvc
          args: --release --features "onnx,symphonia" -o dist
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cpu-windows-x86_64
          path: dist/*.whl

  # ==========================================================================
  # Metal Build (macOS ARM64)
  # ==========================================================================
  
  build-metal:
    name: Build Metal (macOS ARM64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64-apple-darwin
          args: --release --features "onnx,symphonia,metal" -o dist
      
      - name: Rename wheel to indicate Metal
        run: |
          cd dist
          for f in *.whl; do
            # Add +metal suffix before platform tag
            newname=$(echo "$f" | sed 's/-cp/-metal-cp/')
            mv "$f" "$newname"
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-metal-macos-arm64
          path: dist/*.whl

  # ==========================================================================
  # CUDA Builds (Linux)
  # ==========================================================================
  
  build-cuda-linux:
    name: Build CUDA ${{ matrix.cuda }} (Linux x86_64)
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - cuda: '11.8.0'
            cuda_short: 'cu118'
            gcc_version: '11'
          - cuda: '12.4.0'
            cuda_short: 'cu124'
            gcc_version: '12'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install GCC ${{ matrix.gcc_version }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-${{ matrix.gcc_version }} g++-${{ matrix.gcc_version }}
      
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: ${{ matrix.cuda }}
          method: 'network'
          sub-packages: '["nvcc", "cudart-dev", "nvrtc", "nvrtc-dev", "compat"]'
          non-cuda-sub-packages: '["libcublas", "libcublas-dev", "libcurand", "libcurand-dev"]'
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install maturin
        run: pip install maturin
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build wheels
        env:
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
          CUDA_COMPUTE_CAP: "80"
          NVCC_CCBIN: /usr/bin/gcc-${{ matrix.gcc_version }}
          CC: gcc-${{ matrix.gcc_version }}
          CXX: g++-${{ matrix.gcc_version }}
          LD_LIBRARY_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/compat:${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/lib64
        run: |
          mkdir -p dist
          maturin build --release --features "onnx,symphonia,cuda" -o dist
      
      - name: Rename wheel to indicate CUDA version and Ubuntu
        run: |
          cd dist
          for f in *.whl; do
            # Add +cuXXX and ubuntu22.04 suffix before platform tag
            # e.g., cosyvoice3-0.1.0-cp310-abi3-linux_x86_64.whl -> cosyvoice3-0.1.0-cu118-cp310-abi3-ubuntu22_04_x86_64.whl
            newname=$(echo "$f" | sed 's/-cp/-${{ matrix.cuda_short }}-cp/' | sed 's/linux_x86_64/ubuntu22_04_x86_64/')
            mv "$f" "$newname"
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cuda-${{ matrix.cuda_short }}-linux-x86_64
          path: dist/*.whl

  # ==========================================================================
  # CUDA Builds (Windows)
  # ==========================================================================
  
  build-cuda-windows:
    name: Build CUDA ${{ matrix.cuda }} (Windows x86_64)
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - cuda: '11.8.0'
            cuda_short: 'cu118'
            runner: 'windows-2022'  # VS 2022 for CUDA 11.8 compatibility
          - cuda: '12.4.0'
            cuda_short: 'cu124'
            runner: 'windows-2025'  # VS 2026 for CUDA 12.4
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: ${{ matrix.cuda }}
          method: 'network'
          sub-packages: '["nvcc", "cudart", "cublas_dev", "curand_dev", "nvrtc_dev"]'
      
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install maturin
        run: pip install maturin
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Build wheels
        env:
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
          CUDA_COMPUTE_CAP: "80"
        run: |
          New-Item -ItemType Directory -Force -Path dist
          maturin build --release --features "onnx,symphonia,cuda" -o dist
      
      - name: Rename wheel to indicate CUDA version
        shell: bash
        run: |
          cd dist
          for f in *.whl; do
            newname=$(echo "$f" | sed 's/-cp/-${{ matrix.cuda_short }}-cp/')
            mv "$f" "$newname"
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-cuda-${{ matrix.cuda_short }}-windows-x86_64
          path: dist/*.whl

  # ==========================================================================
  # Collect All Wheels (always runs, for download without release)
  # ==========================================================================
  
  collect-wheels:
    name: Collect All Wheels
    needs:
      - build-cpu-linux
      - build-cpu-macos-arm64
      - build-cpu-windows
      - build-metal
      - build-cuda-linux
      - build-cuda-windows
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-wheels
          merge-multiple: true
      
      - name: List all wheels
        run: |
          echo "=== All wheels built ==="
          ls -la all-wheels/
          echo ""
          echo "Total size:"
          du -sh all-wheels/
      
      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels-v${{ inputs.version }}
          path: all-wheels/*.whl
          retention-days: 30

  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  
  release:
    name: Create Release
    needs:
      - collect-wheels
    runs-on: ubuntu-latest
    if: ${{ inputs.create_release }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download combined wheels
        uses: actions/download-artifact@v4
        with:
          name: all-wheels-v${{ inputs.version }}
          path: dist
      
      - name: List wheels
        run: ls -la dist/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: cosyvoice3 v${{ inputs.version }}
          draft: true
          prerelease: false
          files: dist/*.whl
          body: |
            ## cosyvoice3 v${{ inputs.version }}
            
            ### Installation
            
            **CPU version (all platforms):**
            ```bash
            pip install cosyvoice3-${{ inputs.version }}-cp310-abi3-<platform>.whl
            ```
            
            **Metal version (macOS ARM64):**
            ```bash
            pip install cosyvoice3-${{ inputs.version }}-metal-cp310-abi3-macosx_11_0_arm64.whl
            ```
            
            **CUDA version (Linux/Windows):**
            ```bash
            # CUDA 11.8+ (maximum compatibility)
            pip install cosyvoice3-${{ inputs.version }}-cu118-cp310-abi3-<platform>.whl
            
            # CUDA 12.4+ (latest features)
            pip install cosyvoice3-${{ inputs.version }}-cu124-cp310-abi3-<platform>.whl
            ```
            
            ### Wheels included
            
            | Variant | Platform | File |
            |---------|----------|------|
            | CPU | Linux x86_64 | `*-manylinux*.whl` |
            | CPU | macOS ARM64 | `*-macosx*arm64.whl` |
            | CPU | Windows x86_64 | `*-win_amd64.whl` |
            | Metal | macOS ARM64 | `*-metal-*-macosx*arm64.whl` |
            | CUDA 11.8 | Ubuntu 22.04 x86_64 | `*-cu118-*-ubuntu22_04*.whl` |
            | CUDA 11.8 | Windows x86_64 | `*-cu118-*-win_amd64.whl` |
            | CUDA 12.4 | Ubuntu 22.04 x86_64 | `*-cu124-*-ubuntu22_04*.whl` |
            | CUDA 12.4 | Windows x86_64 | `*-cu124-*-win_amd64.whl` |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
